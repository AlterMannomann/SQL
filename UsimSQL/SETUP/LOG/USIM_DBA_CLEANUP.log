SQL> -- get system information roughly formatted
SQL> @@../UTIL/SYSTEM_INFO.sql
SQL> SELECT SYSDATE AS exec_date
  2       , SUBSTR(SYS_CONTEXT('USERENV', 'DB_NAME'), 1, 30) AS db_name
  3       , SUBSTR(SYS_CONTEXT('USERENV', 'CURRENT_SCHEMA'), 1, 30) AS db_schema
  4       , SUBSTR(SYS_CONTEXT('USERENV', 'OS_USER'), 1, 60) AS os_user
  5    FROM dual
  6  ;

EXEC_DATE DB_NAME                        DB_SCHEMA                      OS_USER
--------- ------------------------------ ------------------------------ ------------------------------------------------------------
20-MAY-24 FREEPDB1                       SYS                            Adi

1 Zeile ausgewählt.

SQL>
SQL> -- DROP USERS
SQL> SELECT 'DROP USIM Users' AS info FROM dual;

INFO
---------------
DROP USIM Users

1 Zeile ausgewählt.

SQL> -- USIM_TEST
SQL> SELECT CASE
  2           WHEN COUNT(*) > 0
  3           THEN 'USIM_DROP_TESTUSER.sql'
  4           ELSE '../UTIL/NOTHING_TO_DO.sql "User USIM_TEST does not exist."'
  5         END AS SCRIPTFILE
  6    FROM dba_users
  7   WHERE username = 'USIM_TEST'
  8  ;

SCRIPTFILE
----------------------------------------------------------
USIM_DROP_TESTUSER.sql

1 Zeile ausgewählt.

SQL> @@&SCRIPTFILE
SQL> DROP USER usim_test CASCADE;

User USIM_TEST gelöscht.

SQL> -- USIM
SQL> SELECT CASE
  2           WHEN COUNT(*) > 0
  3           THEN 'USIM_DROP_USER.sql'
  4           ELSE '../UTIL/NOTHING_TO_DO.sql "User USIM does not exist."'
  5         END AS SCRIPTFILE
  6    FROM dba_users
  7   WHERE username = 'USIM'
  8  ;

SCRIPTFILE
-----------------------------------------------------
USIM_DROP_USER.sql

1 Zeile ausgewählt.

SQL> @@&SCRIPTFILE
SQL> DROP USER usim CASCADE;

User USIM gelöscht.

SQL> -- DROP TABLESPACES
SQL> SELECT 'DROP USIM Tablespaces' AS info FROM dual;

INFO
---------------------
DROP USIM Tablespaces

1 Zeile ausgewählt.

SQL> -- USIM_TEST
SQL> SELECT CASE
  2           WHEN COUNT(*) > 0
  3           THEN 'USIM_DROP_TEST_TBL_SPC.sql'
  4           ELSE '../UTIL/NOTHING_TO_DO.sql "Tablespace USIM_TEST does not exist."'
  5         END AS SCRIPTFILE
  6    FROM dba_tablespaces
  7   WHERE tablespace_name = 'USIM_TEST'
  8  ;

SCRIPTFILE
----------------------------------------------------------------
USIM_DROP_TEST_TBL_SPC.sql

1 Zeile ausgewählt.

SQL> @@&SCRIPTFILE
SQL> DROP TABLESPACE usim_test
  2    INCLUDING CONTENTS AND DATAFILES
  3    CASCADE CONSTRAINTS
  4  ;

TABLESPACE USIM_TEST gelöscht.

SQL> -- USIM_LIVE
SQL> SELECT CASE
  2           WHEN COUNT(*) > 0
  3           THEN 'USIM_DROP_TBL_SPC.sql'
  4           ELSE '../UTIL/NOTHING_TO_DO.sql "Tablespace USIM_LIVE does not exist."'
  5         END AS SCRIPTFILE
  6    FROM dba_tablespaces
  7   WHERE tablespace_name = 'USIM_LIVE'
  8  ;

SCRIPTFILE
----------------------------------------------------------------
USIM_DROP_TBL_SPC.sql

1 Zeile ausgewählt.

SQL> @@&SCRIPTFILE
SQL> DROP TABLESPACE usim_live
  2    INCLUDING CONTENTS AND DATAFILES
  3    CASCADE CONSTRAINTS
  4  ;

TABLESPACE USIM_LIVE gelöscht.

SQL> -- DROP PROCEDURES
SQL> SELECT CASE
  2           WHEN COUNT(*) = 1
  3           THEN '../PROCEDURES/DROP/DROP_USIM_RUN_SCRIPT.sql'
  4           ELSE '../UTIL/NOTHING_TO_DO.sql "USIM_RUN_SCRIPT procedure does not exists."'
  5         END AS SCRIPTFILE
  6    FROM dba_objects
  7   WHERE object_name LIKE 'USIM_RUN_SCRIPT'
  8     AND object_type = 'PROCEDURE'
  9  ;

SCRIPTFILE
----------------------------------------------------------------------
../PROCEDURES/DROP/DROP_USIM_RUN_SCRIPT.sql

1 Zeile ausgewählt.

SQL> @@&SCRIPTFILE
SQL> DROP PROCEDURE usim_run_script;

Procedure USIM_RUN_SCRIPT gelöscht.

SQL> SELECT CASE
  2           WHEN COUNT(*) = 1
  3           THEN '../PROCEDURES/DROP/DROP_USIM_RUN_RECREATE.sql'
  4           ELSE '../UTIL/NOTHING_TO_DO.sql "USIM_RUN_RECREATE procedure does not exists."'
  5         END AS SCRIPTFILE
  6    FROM dba_objects
  7   WHERE object_name LIKE 'USIM_RUN_RECREATE'
  8     AND object_type = 'PROCEDURE'
  9  ;

SCRIPTFILE
------------------------------------------------------------------------
../PROCEDURES/DROP/DROP_USIM_RUN_RECREATE.sql

1 Zeile ausgewählt.

SQL> @@&SCRIPTFILE
SQL> DROP PROCEDURE usim_run_recreate;

Procedure USIM_RUN_RECREATE gelöscht.

SQL> SELECT CASE
  2           WHEN COUNT(*) = 1
  3           THEN '../PROCEDURES/DROP/DROP_USIM_RUN_RECREATE_TEST.sql'
  4           ELSE '../UTIL/NOTHING_TO_DO.sql "USIM_RUN_RECREATE_TEST procedure does not exists."'
  5         END AS SCRIPTFILE
  6    FROM dba_objects
  7   WHERE object_name LIKE 'USIM_RUN_RECREATE_TEST'
  8     AND object_type = 'PROCEDURE'
  9  ;

SCRIPTFILE
-----------------------------------------------------------------------------
../PROCEDURES/DROP/DROP_USIM_RUN_RECREATE_TEST.sql

1 Zeile ausgewählt.

SQL> @@&SCRIPTFILE
SQL> DROP PROCEDURE usim_run_recreate_test;

Procedure USIM_RUN_RECREATE_TEST gelöscht.

SQL> -- DROP JOBS AND PROGRAMS
SQL> SELECT CASE
  2           WHEN COUNT(*) > 0
  3           THEN 'USIM_DROP_JOBS.sql'
  4           ELSE '../UTIL/NOTHING_TO_DO.sql "Tablespace USIM_LIVE does not exist."'
  5         END AS SCRIPTFILE
  6    FROM dba_objects
  7   WHERE object_name IN ('RUN_SERVER_SQL', 'RUN_SERVER_SQL_TEST', 'RUN_SQL', 'RUN_SQL_TEST')
  8     AND owner = USER
  9  ;

SCRIPTFILE
----------------------------------------------------------------
USIM_DROP_JOBS.sql

1 Zeile ausgewählt.

SQL> @@&SCRIPTFILE
SQL> -- drop sys jobs for usim
SQL> DECLARE
  2    l_result INTEGER;
  3  BEGIN
  4    SELECT COUNT(*)
  5      INTO l_result
  6      FROM dba_objects
  7     WHERE object_name = 'RUN_SERVER_SQL'
  8       AND object_type = 'JOB'
  9       AND owner = USER
 10    ;
 11    IF l_result = 1
 12    THEN
 13      DBMS_SCHEDULER.DROP_JOB('SYS.RUN_SERVER_SQL', TRUE);
 14    END IF;
 15    SELECT COUNT(*)
 16      INTO l_result
 17      FROM dba_objects
 18     WHERE object_name = 'RUN_SQL'
 19       AND object_type = 'PROGRAM'
 20       AND owner = USER
 21    ;
 22    IF l_result = 1
 23    THEN
 24      DBMS_SCHEDULER.DROP_PROGRAM('SYS.RUN_SQL', TRUE);
 25    END IF;
 26    SELECT COUNT(*)
 27      INTO l_result
 28      FROM dba_objects
 29     WHERE object_name = 'RUN_SERVER_SQL_TEST'
 30       AND object_type = 'JOB'
 31       AND owner = USER
 32    ;
 33    IF l_result = 1
 34    THEN
 35      DBMS_SCHEDULER.DROP_JOB('SYS.RUN_SERVER_SQL_TEST', TRUE);
 36    END IF;
 37    SELECT COUNT(*)
 38      INTO l_result
 39      FROM dba_objects
 40     WHERE object_name = 'RUN_SQL_TEST'
 41       AND object_type = 'PROGRAM'
 42       AND owner = USER
 43    ;
 44    IF l_result = 1
 45    THEN
 46      DBMS_SCHEDULER.DROP_PROGRAM('SYS.RUN_SQL_TEST', TRUE);
 47    END IF;
 48    -- job class also
 49    SELECT COUNT(*)
 50      INTO l_result
 51      FROM dba_scheduler_job_classes
 52     WHERE job_class_name = 'USIM_JOBS'
 53    ;
 54    IF l_result = 1
 55    THEN
 56      DBMS_SCHEDULER.DROP_JOB_CLASS(job_class_name => 'SYS.USIM_JOBS');
 57    END IF;
 58  END;
 59  /
PL/SQL-Prozedur erfolgreich abgeschlossen.
SQL> -- DROP CREDENTIALS
SQL> SELECT CASE
  2           WHEN COUNT(*) > 0
  3           THEN 'USIM_DROP_CREDENTIALS.sql'
  4           ELSE '../UTIL/NOTHING_TO_DO.sql "Credentials OS_ACCESS, DB_ACCESS and DB_ACCESS_TEST does not exists."'
  5         END AS SCRIPTFILE
  6    FROM dba_credentials
  7   WHERE owner = USER
  8     AND credential_name IN ('OS_ACCESS', 'DB_ACCESS', 'DB_ACCESS_TEST')
  9  ;

SCRIPTFILE
------------------------------------------------------------------------------------------------
USIM_DROP_CREDENTIALS.sql

1 Zeile ausgewählt.

SQL> @@&SCRIPTFILE
SQL> DECLARE
  2    l_result INTEGER;
  3  BEGIN
  4    SELECT COUNT(*)
  5      INTO l_result
  6      FROM dba_credentials
  7     WHERE owner = USER
  8       AND credential_name = 'OS_ACCESS'
  9    ;
 10    IF l_result = 1
 11    THEN
 12      DBMS_CREDENTIAL.DROP_CREDENTIAL('SYS.OS_ACCESS', TRUE);
 13    END IF;
 14    SELECT COUNT(*)
 15      INTO l_result
 16      FROM dba_credentials
 17     WHERE owner = USER
 18       AND credential_name = 'DB_ACCESS'
 19    ;
 20    IF l_result = 1
 21    THEN
 22      DBMS_CREDENTIAL.DROP_CREDENTIAL('SYS.DB_ACCESS', TRUE);
 23    END IF;
 24    SELECT COUNT(*)
 25      INTO l_result
 26      FROM dba_credentials
 27     WHERE owner = USER
 28       AND credential_name = 'DB_ACCESS_TEST'
 29    ;
 30    IF l_result = 1
 31    THEN
 32      DBMS_CREDENTIAL.DROP_CREDENTIAL('SYS.DB_ACCESS_TEST', TRUE);
 33    END IF;
 34  END;
 35  /
PL/SQL-Prozedur erfolgreich abgeschlossen.
SQL> -- DROP DIRECTORIES
SQL> SELECT CASE
  2           WHEN COUNT(*) = 3
  3           THEN 'USIM_DROP_DIRECTORIES.sql'
  4           WHEN COUNT(*) = 0
  5           THEN '../UTIL/NOTHING_TO_DO.sql "Directories USIM_DIR, USIM_HIST_DIR and USIM_SCRIPT_DIR do not exists."'
  6           ELSE '../UTIL/EXIT_SCRIPT_WITH_ERROR.sql "Cleanup failed remove directories manually before."'
  7         END AS SCRIPTFILE
  8    FROM dba_directories
  9   WHERE directory_name IN ('USIM_DIR', 'USIM_HIST_DIR', 'USIM_SCRIPT_DIR')
 10  ;

SCRIPTFILE
--------------------------------------------------------------------------------------------------
USIM_DROP_DIRECTORIES.sql

1 Zeile ausgewählt.

SQL> @@&SCRIPTFILE
SQL> -- one may fail if not all directories are present
SQL> DROP DIRECTORY usim_dir;

Directory USIM_DIR gelöscht.

SQL> DROP DIRECTORY usim_hist_dir;

Directory USIM_HIST_DIR gelöscht.

SQL> DROP DIRECTORY usim_script_dir;

Directory USIM_SCRIPT_DIR gelöscht.

SQL> SPOOL OFF
