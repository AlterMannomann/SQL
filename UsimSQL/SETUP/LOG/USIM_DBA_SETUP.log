SQL> -- get system information roughly formatted
SQL> @@../UTIL/SYSTEM_INFO.sql
SQL> SELECT TO_CHAR(SYSDATE, 'DD.MM.YYYY HH24:MI:SS') AS exec_date
  2       , SUBSTR(SYS_CONTEXT('USERENV', 'DB_NAME'), 1, 30) AS db_name
  3       , SUBSTR(SYS_CONTEXT('USERENV', 'CURRENT_SCHEMA'), 1, 30) AS db_schema
  4       , SUBSTR(SYS_CONTEXT('USERENV', 'OS_USER'), 1, 60) AS os_user
  5    FROM dual
  6  ;

EXEC_DATE           DB_NAME                        DB_SCHEMA                      OS_USER
------------------- ------------------------------ ------------------------------ ------------------------------------------------------------
30.05.2024 20:08:53 FREEPDB1                       SYS                            Adi

1 Zeile ausgewählt.

SQL> -- get parameter to use - can be skipped with ok for objects that exist already
SQL> ACCEPT USIM_SCRIPTS CHAR DEFAULT '/opt/oracle/USIM' PROMPT 'Main directory for script files (a valid server directory like C:\Users\xxx\Documents\SQL\UsimSQL or /opt/oracle/USIM - the default):'
SQL> ACCEPT USER_OS CHAR DEFAULT 'oracle' PROMPT 'OS username for DB server (default ORACLE): '
SQL> ACCEPT PASS_OS CHAR DEFAULT 'oracle' PROMPT 'OS password for DB server (default oracle): '
SQL> ACCEPT PASS_USIM CHAR DEFAULT 'usim' PROMPT 'Password for user USIM (default usim): '
SQL> ACCEPT PASS_USIM_TEST CHAR DEFAULT 'usim' PROMPT 'Password for user USIM_TEST (default usim): '
SQL> COLUMN USIM_TERMINATOR NEW_VAL USIM_TERMINATOR
SQL> SELECT CASE
  2           WHEN INSTR('&USIM_SCRIPTS', ':') > 0
  3           THEN '\'
  4           ELSE '/'
  5         END AS USIM_TERMINATOR
  6    FROM dual
  7  ;
alt:SELECT CASE
         WHEN INSTR('&USIM_SCRIPTS', ':') > 0
         THEN '\'
         ELSE '/'
       END AS USIM_TERMINATOR
  FROM dual

neu:SELECT CASE
         WHEN INSTR('/opt/oracle/USIM', ':') > 0
         THEN '\'
         ELSE '/'
       END AS USIM_TERMINATOR
  FROM dual

U
-
/

1 Zeile ausgewählt.

SQL> COLUMN USIM_DIRECTORY NEW_VAL USIM_DIRECTORY
SQL> COLUMN USIM_HISTORY NEW_VAL USIM_HISTORY
SQL> COLUMN USIM_SETUP NEW_VAL USIM_SETUP
SQL> COLUMN USIM_SHELL NEW_VAL USIM_SHELL
SQL> COLUMN USIM_LOGS NEW_VAL USIM_LOGS
SQL> SELECT '&USIM_SCRIPTS.&USIM_TERMINATOR.JS' AS USIM_DIRECTORY
  2       , '&USIM_SCRIPTS.&USIM_TERMINATOR.JS&USIM_TERMINATOR.SpaceLog' AS USIM_HISTORY
  3       , '&USIM_SCRIPTS.&USIM_TERMINATOR.SETUP' AS USIM_SETUP
  4       , '&USIM_SCRIPTS.&USIM_TERMINATOR.SH' AS USIM_SHELL
  5       , '&USIM_SCRIPTS.&USIM_TERMINATOR.SETUP&USIM_TERMINATOR.LOG' AS USIM_LOGS
  6    FROM dual
  7  ;
alt:SELECT '&USIM_SCRIPTS.&USIM_TERMINATOR.JS' AS USIM_DIRECTORY
     , '&USIM_SCRIPTS.&USIM_TERMINATOR.JS&USIM_TERMINATOR.SpaceLog' AS USIM_HISTORY
     , '&USIM_SCRIPTS.&USIM_TERMINATOR.SETUP' AS USIM_SETUP
     , '&USIM_SCRIPTS.&USIM_TERMINATOR.SH' AS USIM_SHELL
     , '&USIM_SCRIPTS.&USIM_TERMINATOR.SETUP&USIM_TERMINATOR.LOG' AS USIM_LOGS
  FROM dual

neu:SELECT '/opt/oracle/USIM/JS' AS USIM_DIRECTORY
     , '/opt/oracle/USIM/JS/SpaceLog' AS USIM_HISTORY
     , '/opt/oracle/USIM/SETUP' AS USIM_SETUP
     , '/opt/oracle/USIM/SH' AS USIM_SHELL
     , '/opt/oracle/USIM/SETUP/LOG' AS USIM_LOGS
  FROM dual

USIM_DIRECTORY      USIM_HISTORY                 USIM_SETUP             USIM_SHELL          USIM_LOGS
------------------- ---------------------------- ---------------------- ------------------- --------------------------
/opt/oracle/USIM/JS /opt/oracle/USIM/JS/SpaceLog /opt/oracle/USIM/SETUP /opt/oracle/USIM/SH /opt/oracle/USIM/SETUP/LOG

1 Zeile ausgewählt.

SQL> COLUMN CONFIG_INFO NEW_VAL CONFIG_INFO
SQL> SELECT 'Current configuration' || CHR(13) || CHR(10) ||
  2         'Main directory: &USIM_SCRIPTS' || CHR(13) || CHR(10) ||
  3         'Space log directory: &USIM_DIRECTORY' || CHR(13) || CHR(10) ||
  4         'History log directory: &USIM_HISTORY' || CHR(13) || CHR(10) ||
  5         'Install logfile directory: &USIM_LOGS' || CHR(13) || CHR(10) ||
  6         'Shell script directory: &USIM_SHELL' || CHR(13) || CHR(10) ||
  7         'Server user: &USER_OS' || CHR(13) || CHR(10) ||
  8         'Server user password: &PASS_OS' || CHR(13) || CHR(10) ||
  9         'USIM password: &PASS_USIM' || CHR(13) || CHR(10) ||
 10         'USIM_TEST password: &PASS_USIM_TEST' || CHR(13) ||  CHR(10) || CHR(13) || CHR(10) ||
 11         'Remark: If you care about security this is the wrong application for you. Press Yes to install or No to cancel.' AS CONFIG_INFO
 12    FROM dual
 13  ;
alt:SELECT 'Current configuration' || CHR(13) || CHR(10) ||
       'Main directory: &USIM_SCRIPTS' || CHR(13) || CHR(10) ||
       'Space log directory: &USIM_DIRECTORY' || CHR(13) || CHR(10) ||
       'History log directory: &USIM_HISTORY' || CHR(13) || CHR(10) ||
       'Install logfile directory: &USIM_LOGS' || CHR(13) || CHR(10) ||
       'Shell script directory: &USIM_SHELL' || CHR(13) || CHR(10) ||
       'Server user: &USER_OS' || CHR(13) || CHR(10) ||
       'Server user password: &PASS_OS' || CHR(13) || CHR(10) ||
       'USIM password: &PASS_USIM' || CHR(13) || CHR(10) ||
       'USIM_TEST password: &PASS_USIM_TEST' || CHR(13) ||  CHR(10) || CHR(13) || CHR(10) ||
       'Remark: If you care about security this is the wrong application for you. Press Yes to install or No to cancel.' AS CONFIG_INFO
  FROM dual

neu:SELECT 'Current configuration' || CHR(13) || CHR(10) ||
       'Main directory: /opt/oracle/USIM' || CHR(13) || CHR(10) ||
       'Space log directory: /opt/oracle/USIM/JS' || CHR(13) || CHR(10) ||
       'History log directory: /opt/oracle/USIM/JS/SpaceLog' || CHR(13) || CHR(10) ||
       'Install logfile directory: /opt/oracle/USIM/SETUP/LOG' || CHR(13) || CHR(10) ||
       'Shell script directory: /opt/oracle/USIM/SH' || CHR(13) || CHR(10) ||
       'Server user: oracle' || CHR(13) || CHR(10) ||
       'Server user password: oracle' || CHR(13) || CHR(10) ||
       'USIM password: usim' || CHR(13) || CHR(10) ||
       'USIM_TEST password: usim' || CHR(13) ||  CHR(10) || CHR(13) || CHR(10) ||
       'Remark: If you care about security this is the wrong application for you. Press Yes to install or No to cancel.' AS CONFIG_INFO
  FROM dual

CONFIG_INFO
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Current configuration
Main directory: /opt/oracle/USIM
Space log directory: /opt/oracle/USIM/JS
History log directory: /opt/oracle/USIM/JS/SpaceLog
Install logfile directory: /opt/oracle/USIM/SETUP/LOG
Shell script directory: /opt/oracle/USIM/SH
Server user: oracle
Server user password: oracle
USIM password: usim
USIM_TEST password: usim

Remark: If you care about security this is the wrong application for you. Press Yes to install or No to cancel.


1 Zeile ausgewählt.

SQL> PAUSE &CONFIG_INFO
SQL> -- CREATE TABLESPACES
SQL> SELECT 'CREATE USIM tablespaces' AS info FROM dual;

INFO
-----------------------
CREATE USIM tablespaces

1 Zeile ausgewählt.

SQL> -- USIM_LIVE
SQL> SELECT CASE
  2           WHEN COUNT(*) = 0
  3           THEN 'USIM_CREATE_TBL_SPC.sql'
  4           ELSE '../UTIL/NOTHING_TO_DO.sql "Tablespace USIM_LIVE already exists."'
  5         END AS SCRIPTFILE
  6    FROM dba_tablespaces
  7   WHERE tablespace_name = 'USIM_LIVE'
  8  ;

SCRIPTFILE
----------------------------------------------------------------
USIM_CREATE_TBL_SPC.sql

1 Zeile ausgewählt.

SQL> @@&SCRIPTFILE
SQL> CREATE BIGFILE TABLESPACE usim_live
  2    DATAFILE 'usim01.dbf'
  3      SIZE 5G
  4      AUTOEXTEND ON
  5  ;

TABLESPACE USIM_LIVE erstellt.

SQL> -- USIM_TEST
SQL> SELECT CASE
  2           WHEN COUNT(*) = 0
  3           THEN 'USIM_CREATE_TEST_TBL_SPC.sql'
  4           ELSE '../UTIL/NOTHING_TO_DO.sql "Tablespace USIM_TEST already exists."'
  5         END AS SCRIPTFILE
  6    FROM dba_tablespaces
  7   WHERE tablespace_name = 'USIM_TEST'
  8  ;

SCRIPTFILE
----------------------------------------------------------------
USIM_CREATE_TEST_TBL_SPC.sql

1 Zeile ausgewählt.

SQL> @@&SCRIPTFILE
SQL> CREATE TABLESPACE usim_test
  2    DATAFILE 'usim_test01.dbf'
  3      SIZE 100M
  4      AUTOEXTEND ON
  5  ;

TABLESPACE USIM_TEST erstellt.

SQL> -- CREATE CREDENTIALS
SQL> SELECT 'CREATE USIM credentials' AS info FROM dual;

INFO
-----------------------
CREATE USIM credentials

1 Zeile ausgewählt.

SQL> SELECT CASE
  2           WHEN COUNT(*) = 0
  3           THEN 'USIM_CREATE_CREDENTIALS.sql'
  4           WHEN COUNT(*) = 3
  5           THEN '../UTIL/NOTHING_TO_DO.sql "Credentials USIM_OS_ACCESS, USIM_DB_ACCESS and USIM_DB_ACCESS_TEST already exists."'
  6           ELSE '../UTIL/EXIT_SCRIPT_WITH_ERROR.sql "Cleanup failed remove credentials manually before."'
  7         END AS SCRIPTFILE
  8    FROM dba_credentials
  9   WHERE owner = USER
 10     AND credential_name IN ('USIM_OS_ACCESS', 'USIM_DB_ACCESS', 'USIM_DB_ACCESS_TEST')
 11  ;

SCRIPTFILE
--------------------------------------------------------------------------------------------------------------
USIM_CREATE_CREDENTIALS.sql

1 Zeile ausgewählt.

SQL> @@&SCRIPTFILE
SQL> -- create credentials for scheduler jobs running server scripts
SQL> BEGIN
  2    DBMS_CREDENTIAL.CREATE_CREDENTIAL( username => '&USER_OS'
  3                                     , password => '&PASS_OS'
  4                                     , comments => 'OS_ACCESS for server script execution'
  5                                     , credential_name => 'USIM_OS_ACCESS'
  6                                     )
  7    ;
  8    DBMS_CREDENTIAL.CREATE_CREDENTIAL( username => 'USIM'
  9                                     , password => '&PASS_USIM'
 10                                     , comments => 'DB_ACCESS USIM for server script execution'
 11                                     , credential_name => 'USIM_DB_ACCESS'
 12                                     )
 13    ;
 14    DBMS_CREDENTIAL.CREATE_CREDENTIAL( username => 'USIM_TEST'
 15                                     , password => '&PASS_USIM_TEST'
 16                                     , comments => 'DB_ACCESS USIM_TEST for server script execution'
 17                                     , credential_name => 'USIM_DB_ACCESS_TEST'
 18                                     )
 19    ;
 20  END;
 21  /
alt:BEGIN
  DBMS_CREDENTIAL.CREATE_CREDENTIAL( username => '&USER_OS'
                                   , password => '&PASS_OS'
                                   , comments => 'OS_ACCESS for server script execution'
                                   , credential_name => 'USIM_OS_ACCESS'
                                   )
  ;
  DBMS_CREDENTIAL.CREATE_CREDENTIAL( username => 'USIM'
                                   , password => '&PASS_USIM'
                                   , comments => 'DB_ACCESS USIM for server script execution'
                                   , credential_name => 'USIM_DB_ACCESS'
                                   )
  ;
  DBMS_CREDENTIAL.CREATE_CREDENTIAL( username => 'USIM_TEST'
                                   , password => '&PASS_USIM_TEST'
                                   , comments => 'DB_ACCESS USIM_TEST for server script execution'
                                   , credential_name => 'USIM_DB_ACCESS_TEST'
                                   )
  ;
END;

neu:BEGIN
  DBMS_CREDENTIAL.CREATE_CREDENTIAL( username => 'oracle'
                                   , password => 'oracle'
                                   , comments => 'OS_ACCESS for server script execution'
                                   , credential_name => 'USIM_OS_ACCESS'
                                   )
  ;
  DBMS_CREDENTIAL.CREATE_CREDENTIAL( username => 'USIM'
                                   , password => 'usim'
                                   , comments => 'DB_ACCESS USIM for server script execution'
                                   , credential_name => 'USIM_DB_ACCESS'
                                   )
  ;
  DBMS_CREDENTIAL.CREATE_CREDENTIAL( username => 'USIM_TEST'
                                   , password => 'usim'
                                   , comments => 'DB_ACCESS USIM_TEST for server script execution'
                                   , credential_name => 'USIM_DB_ACCESS_TEST'
                                   )
  ;
END;
PL/SQL-Prozedur erfolgreich abgeschlossen.
SQL> -- CREATE DIRECTORY, we expect a proper cleanup, may fail if cleanup failed
SQL> SELECT 'CREATE USIM directories' AS info FROM dual;

INFO
-----------------------
CREATE USIM directories

1 Zeile ausgewählt.

SQL> SELECT CASE
  2           WHEN COUNT(*) = 0
  3           THEN 'USIM_CREATE_DIRECTORIES.sql'
  4           WHEN COUNT(*) = 4
  5           THEN '../UTIL/NOTHING_TO_DO.sql "Directories USIM_DIR, USIM_HIST_DIR and USIM_SCRIPT_DIR already exists."'
  6           ELSE '../UTIL/EXIT_SCRIPT_WITH_ERROR.sql "Cleanup failed remove directories manually before."'
  7         END AS SCRIPTFILE
  8    FROM dba_directories
  9   WHERE directory_name IN ('USIM_DIR', 'USIM_HIST_DIR', 'USIM_SCRIPT_DIR', 'USIM_LOG_DIR')
 10  ;

SCRIPTFILE
---------------------------------------------------------------------------------------------------
USIM_CREATE_DIRECTORIES.sql

1 Zeile ausgewählt.

SQL> @@&SCRIPTFILE
SQL> -- a new file is always copied to the main directory. Before copying, the current file, if it exists,
SQL> -- is copied to the history directory with a unique name.
SQL> CREATE OR REPLACE DIRECTORY usim_dir AS '&USIM_DIRECTORY';
alt:CREATE OR REPLACE DIRECTORY usim_dir AS '&USIM_DIRECTORY'
neu:CREATE OR REPLACE DIRECTORY usim_dir AS '/opt/oracle/USIM/JS'

Directory USIM_DIR erstellt.

SQL> CREATE OR REPLACE DIRECTORY usim_hist_dir AS '&USIM_HISTORY';
alt:CREATE OR REPLACE DIRECTORY usim_hist_dir AS '&USIM_HISTORY'
neu:CREATE OR REPLACE DIRECTORY usim_hist_dir AS '/opt/oracle/USIM/JS/SpaceLog'

Directory USIM_HIST_DIR erstellt.

SQL> -- script main directory for script runs
SQL> CREATE OR REPLACE DIRECTORY usim_script_dir AS '&USIM_SCRIPTS';
alt:CREATE OR REPLACE DIRECTORY usim_script_dir AS '&USIM_SCRIPTS'
neu:CREATE OR REPLACE DIRECTORY usim_script_dir AS '/opt/oracle/USIM'

Directory USIM_SCRIPT_DIR erstellt.

SQL> -- installation log files
SQL> CREATE OR REPLACE DIRECTORY usim_log_dir AS '&USIM_LOGS';
alt:CREATE OR REPLACE DIRECTORY usim_log_dir AS '&USIM_LOGS'
neu:CREATE OR REPLACE DIRECTORY usim_log_dir AS '/opt/oracle/USIM/SETUP/LOG'

Directory USIM_LOG_DIR erstellt.

SQL> -- CREATE JOBS, we expect a proper cleanup, may fail if cleanup failed
SQL> SELECT 'CREATE USIM related jobs' AS info FROM dual;

INFO
------------------------
CREATE USIM related jobs

1 Zeile ausgewählt.

SQL> SELECT CASE
  2           WHEN NVL(SUM(installed), 0) = 0
  3           THEN 'USIM_CREATE_JOBS.sql'
  4           WHEN SUM(installed) = 4
  5           THEN '../UTIL/NOTHING_TO_DO.sql "Job USIM_RUN_SERVER_SQL and program USIM_RUN_SQL already exists for live and test."'
  6           ELSE '../UTIL/EXIT_SCRIPT_WITH_ERROR.sql "Cleanup failed remove job and program manually before."'
  7         END AS SCRIPTFILE
  8    FROM (SELECT CASE
  9                   WHEN object_name IN ('USIM_RUN_SERVER_SQL', 'USIM_RUN_SERVER_SQL_TEST')
 10                    AND object_type = 'JOB'
 11                   THEN 1
 12                   WHEN object_name IN ('USIM_RUN_SQL', 'USIM_RUN_SQL_TEST')
 13                    AND object_type = 'PROGRAM'
 14                   THEN 1
 15                   ELSE 0
 16                 END AS installed
 17            FROM dba_objects
 18           WHERE object_name IN ('USIM_RUN_SERVER_SQL', 'USIM_RUN_SERVER_SQL_TEST', 'USIM_RUN_SQL', 'USIM_RUN_SQL_TEST')
 19             AND owner = USER
 20         )
 21  ;

SCRIPTFILE
--------------------------------------------------------------------------------------------------------------
USIM_CREATE_JOBS.sql

1 Zeile ausgewählt.

SQL> @@&SCRIPTFILE
SQL> -- prebuild programs and jobs to create or recreate the schema DDL
SQL> BEGIN
  2    DBMS_SCHEDULER.CREATE_JOB_CLASS( job_class_name => 'USIM_JOBS'
  3                                   , resource_consumer_group => 'SYS_GROUP'
  4                                   , logging_level => DBMS_SCHEDULER.LOGGING_FULL
  5                                   )
  6    ;
  7    DBMS_SCHEDULER.CREATE_PROGRAM( program_name => 'USIM_RUN_SQL'
  8                                 , program_type => 'EXTERNAL_SCRIPT'
  9                                 , program_action => '&USIM_SHELL./run_sql.sh'
 10                                 , number_of_arguments => 3
 11                                 , enabled => FALSE
 12                                 , comments => 'Provide program with parameters to run sql script on server in the correct directory for USIM'
 13                                 )
 14    ;
 15    DBMS_SCHEDULER.DEFINE_PROGRAM_ARGUMENT( program_name => 'USIM_RUN_SQL'
 16                                          , argument_position => 1
 17                                          , argument_name => 'SCRIPT_PATH'
 18                                          , argument_type => 'VARCHAR2'
 19                                          , default_value => '&USIM_SETUP'
 20                                          )
 21    ;
 22    DBMS_SCHEDULER.DEFINE_PROGRAM_ARGUMENT( program_name => 'USIM_RUN_SQL'
 23                                          , argument_position => 2
 24                                          , argument_name => 'SCRIPT_NAME'
 25                                          , argument_type => 'VARCHAR2'
 26                                          , default_value => 'USIM_SETUP.sql'
 27                                          )
 28    ;
 29    DBMS_SCHEDULER.DEFINE_PROGRAM_ARGUMENT( program_name => 'USIM_RUN_SQL'
 30                                          , argument_position => 3
 31                                          , argument_name => 'DB_USER'
 32                                          , argument_type => 'VARCHAR2'
 33                                          , default_value => 'USIM'
 34                                          )
 35    ;
 36    DBMS_SCHEDULER.ENABLE( name => 'USIM_RUN_SQL');
 37    DBMS_SCHEDULER.CREATE_PROGRAM( program_name => 'USIM_RUN_SQL_TEST'
 38                                 , program_type => 'EXTERNAL_SCRIPT'
 39                                 , program_action => '&USIM_SHELL./run_sql.sh'
 40                                 , number_of_arguments => 3
 41                                 , enabled => FALSE
 42                                 , comments => 'Provide program with parameters to run sql script on server in the correct directory for USIM_TEST'
 43                                 )
 44    ;
 45    DBMS_SCHEDULER.DEFINE_PROGRAM_ARGUMENT( program_name => 'USIM_RUN_SQL_TEST'
 46                                          , argument_position => 1
 47                                          , argument_name => 'SCRIPT_PATH'
 48                                          , argument_type => 'VARCHAR2'
 49                                          , default_value => '&USIM_SETUP'
 50                                          )
 51    ;
 52    DBMS_SCHEDULER.DEFINE_PROGRAM_ARGUMENT( program_name => 'USIM_RUN_SQL_TEST'
 53                                          , argument_position => 2
 54                                          , argument_name => 'SCRIPT_NAME'
 55                                          , argument_type => 'VARCHAR2'
 56                                          , default_value => 'USIM_TEST_SETUP.sql'
 57                                          )
 58    ;
 59    DBMS_SCHEDULER.DEFINE_PROGRAM_ARGUMENT( program_name => 'USIM_RUN_SQL_TEST'
 60                                          , argument_position => 3
 61                                          , argument_name => 'DB_USER'
 62                                          , argument_type => 'VARCHAR2'
 63                                          , default_value => 'USIM_TEST'
 64                                          )
 65    ;
 66    DBMS_SCHEDULER.ENABLE( name => 'USIM_RUN_SQL_TEST');
 67    DBMS_SCHEDULER.CREATE_JOB( job_name => 'USIM_RUN_SERVER_SQL'
 68                             , program_name => 'USIM_RUN_SQL'
 69                             , start_date => NULL
 70                             , repeat_interval => NULL
 71                             , end_date => NULL
 72                             , enabled => FALSE
 73                             , job_class => 'USIM_JOBS'
 74                             , auto_drop => FALSE
 75                             , comments => 'Runs sql scripts on the server for USIM'
 76                             , credential_name => 'USIM_OS_ACCESS'
 77                             , job_style => 'REGULAR'
 78                             );
 79
 80    DBMS_SCHEDULER.SET_ATTRIBUTE( name => 'USIM_RUN_SERVER_SQL'
 81                                , attribute => 'store_output'
 82                                , value => TRUE
 83                                )
 84    ;
 85    DBMS_SCHEDULER.SET_ATTRIBUTE( name => 'USIM_RUN_SERVER_SQL'
 86                                , attribute => 'logging_level'
 87                                , value => DBMS_SCHEDULER.LOGGING_FULL
 88                                )
 89    ;
 90    DBMS_SCHEDULER.SET_ATTRIBUTE( name => 'USIM_RUN_SERVER_SQL'
 91                                , attribute => 'connect_credential_name'
 92                                , value => 'USIM_DB_ACCESS'
 93                                )
 94    ;
 95    DBMS_SCHEDULER.CREATE_JOB( job_name => 'USIM_RUN_SERVER_SQL_TEST'
 96                             , program_name => 'USIM_RUN_SQL_TEST'
 97                             , start_date => NULL
 98                             , repeat_interval => NULL
 99                             , end_date => NULL
100                             , enabled => FALSE
101                             , job_class => 'USIM_JOBS'
102                             , auto_drop => FALSE
103                             , comments => 'Runs sql scripts on the server for USIM_TEST'
104                             , credential_name => 'USIM_OS_ACCESS'
105                             , job_style => 'REGULAR'
106                             )
107    ;
108    DBMS_SCHEDULER.SET_ATTRIBUTE( name => 'USIM_RUN_SERVER_SQL_TEST'
109                                , attribute => 'store_output'
110                                , value => TRUE
111                                )
112    ;
113    DBMS_SCHEDULER.SET_ATTRIBUTE( name => 'USIM_RUN_SERVER_SQL_TEST'
114                                , attribute => 'logging_level'
115                                , value => DBMS_SCHEDULER.LOGGING_FULL
116                                )
117    ;
118    DBMS_SCHEDULER.SET_ATTRIBUTE( name => 'USIM_RUN_SERVER_SQL_TEST'
119                                , attribute => 'connect_credential_name'
120                                , value => 'USIM_DB_ACCESS_TEST'
121                                )
122    ;
123    -- no job enable, runs instantly
124  END;
125  /
alt:BEGIN
  DBMS_SCHEDULER.CREATE_JOB_CLASS( job_class_name => 'USIM_JOBS'
                                 , resource_consumer_group => 'SYS_GROUP'
                                 , logging_level => DBMS_SCHEDULER.LOGGING_FULL
                                 )
  ;
  DBMS_SCHEDULER.CREATE_PROGRAM( program_name => 'USIM_RUN_SQL'
                               , program_type => 'EXTERNAL_SCRIPT'
                               , program_action => '&USIM_SHELL./run_sql.sh'
                               , number_of_arguments => 3
                               , enabled => FALSE
                               , comments => 'Provide program with parameters to run sql script on server in the correct directory for USIM'
                               )
  ;
  DBMS_SCHEDULER.DEFINE_PROGRAM_ARGUMENT( program_name => 'USIM_RUN_SQL'
                                        , argument_position => 1
                                        , argument_name => 'SCRIPT_PATH'
                                        , argument_type => 'VARCHAR2'
                                        , default_value => '&USIM_SETUP'
                                        )
  ;
  DBMS_SCHEDULER.DEFINE_PROGRAM_ARGUMENT( program_name => 'USIM_RUN_SQL'
                                        , argument_position => 2
                                        , argument_name => 'SCRIPT_NAME'
                                        , argument_type => 'VARCHAR2'
                                        , default_value => 'USIM_SETUP.sql'
                                        )
  ;
  DBMS_SCHEDULER.DEFINE_PROGRAM_ARGUMENT( program_name => 'USIM_RUN_SQL'
                                        , argument_position => 3
                                        , argument_name => 'DB_USER'
                                        , argument_type => 'VARCHAR2'
                                        , default_value => 'USIM'
                                        )
  ;
  DBMS_SCHEDULER.ENABLE( name => 'USIM_RUN_SQL');
  DBMS_SCHEDULER.CREATE_PROGRAM( program_name => 'USIM_RUN_SQL_TEST'
                               , program_type => 'EXTERNAL_SCRIPT'
                               , program_action => '&USIM_SHELL./run_sql.sh'
                               , number_of_arguments => 3
                               , enabled => FALSE
                               , comments => 'Provide program with parameters to run sql script on server in the correct directory for USIM_TEST'
                               )
  ;
  DBMS_SCHEDULER.DEFINE_PROGRAM_ARGUMENT( program_name => 'USIM_RUN_SQL_TEST'
                                        , argument_position => 1
                                        , argument_name => 'SCRIPT_PATH'
                                        , argument_type => 'VARCHAR2'
                                        , default_value => '&USIM_SETUP'
                                        )
  ;
  DBMS_SCHEDULER.DEFINE_PROGRAM_ARGUMENT( program_name => 'USIM_RUN_SQL_TEST'
                                        , argument_position => 2
                                        , argument_name => 'SCRIPT_NAME'
                                        , argument_type => 'VARCHAR2'
                                        , default_value => 'USIM_TEST_SETUP.sql'
                                        )
  ;
  DBMS_SCHEDULER.DEFINE_PROGRAM_ARGUMENT( program_name => 'USIM_RUN_SQL_TEST'
                                        , argument_position => 3
                                        , argument_name => 'DB_USER'
                                        , argument_type => 'VARCHAR2'
                                        , default_value => 'USIM_TEST'
                                        )
  ;
  DBMS_SCHEDULER.ENABLE( name => 'USIM_RUN_SQL_TEST');
  DBMS_SCHEDULER.CREATE_JOB( job_name => 'USIM_RUN_SERVER_SQL'
                           , program_name => 'USIM_RUN_SQL'
                           , start_date => NULL
                           , repeat_interval => NULL
                           , end_date => NULL
                           , enabled => FALSE
                           , job_class => 'USIM_JOBS'
                           , auto_drop => FALSE
                           , comments => 'Runs sql scripts on the server for USIM'
                           , credential_name => 'USIM_OS_ACCESS'
                           , job_style => 'REGULAR'
                           );

  DBMS_SCHEDULER.SET_ATTRIBUTE( name => 'USIM_RUN_SERVER_SQL'
                              , attribute => 'store_output'
                              , value => TRUE
                              )
  ;
  DBMS_SCHEDULER.SET_ATTRIBUTE( name => 'USIM_RUN_SERVER_SQL'
                              , attribute => 'logging_level'
                              , value => DBMS_SCHEDULER.LOGGING_FULL
                              )
  ;
  DBMS_SCHEDULER.SET_ATTRIBUTE( name => 'USIM_RUN_SERVER_SQL'
                              , attribute => 'connect_credential_name'
                              , value => 'USIM_DB_ACCESS'
                              )
  ;
  DBMS_SCHEDULER.CREATE_JOB( job_name => 'USIM_RUN_SERVER_SQL_TEST'
                           , program_name => 'USIM_RUN_SQL_TEST'
                           , start_date => NULL
                           , repeat_interval => NULL
                           , end_date => NULL
                           , enabled => FALSE
                           , job_class => 'USIM_JOBS'
                           , auto_drop => FALSE
                           , comments => 'Runs sql scripts on the server for USIM_TEST'
                           , credential_name => 'USIM_OS_ACCESS'
                           , job_style => 'REGULAR'
                           )
  ;
  DBMS_SCHEDULER.SET_ATTRIBUTE( name => 'USIM_RUN_SERVER_SQL_TEST'
                              , attribute => 'store_output'
                              , value => TRUE
                              )
  ;
  DBMS_SCHEDULER.SET_ATTRIBUTE( name => 'USIM_RUN_SERVER_SQL_TEST'
                              , attribute => 'logging_level'
                              , value => DBMS_SCHEDULER.LOGGING_FULL
                              )
  ;
  DBMS_SCHEDULER.SET_ATTRIBUTE( name => 'USIM_RUN_SERVER_SQL_TEST'
                              , attribute => 'connect_credential_name'
                              , value => 'USIM_DB_ACCESS_TEST'
                              )
  ;
  -- no job enable, runs instantly
END;

neu:BEGIN
  DBMS_SCHEDULER.CREATE_JOB_CLASS( job_class_name => 'USIM_JOBS'
                                 , resource_consumer_group => 'SYS_GROUP'
                                 , logging_level => DBMS_SCHEDULER.LOGGING_FULL
                                 )
  ;
  DBMS_SCHEDULER.CREATE_PROGRAM( program_name => 'USIM_RUN_SQL'
                               , program_type => 'EXTERNAL_SCRIPT'
                               , program_action => '/opt/oracle/USIM/SH/run_sql.sh'
                               , number_of_arguments => 3
                               , enabled => FALSE
                               , comments => 'Provide program with parameters to run sql script on server in the correct directory for USIM'
                               )
  ;
  DBMS_SCHEDULER.DEFINE_PROGRAM_ARGUMENT( program_name => 'USIM_RUN_SQL'
                                        , argument_position => 1
                                        , argument_name => 'SCRIPT_PATH'
                                        , argument_type => 'VARCHAR2'
                                        , default_value => '/opt/oracle/USIM/SETUP'
                                        )
  ;
  DBMS_SCHEDULER.DEFINE_PROGRAM_ARGUMENT( program_name => 'USIM_RUN_SQL'
                                        , argument_position => 2
                                        , argument_name => 'SCRIPT_NAME'
                                        , argument_type => 'VARCHAR2'
                                        , default_value => 'USIM_SETUP.sql'
                                        )
  ;
  DBMS_SCHEDULER.DEFINE_PROGRAM_ARGUMENT( program_name => 'USIM_RUN_SQL'
                                        , argument_position => 3
                                        , argument_name => 'DB_USER'
                                        , argument_type => 'VARCHAR2'
                                        , default_value => 'USIM'
                                        )
  ;
  DBMS_SCHEDULER.ENABLE( name => 'USIM_RUN_SQL');
  DBMS_SCHEDULER.CREATE_PROGRAM( program_name => 'USIM_RUN_SQL_TEST'
                               , program_type => 'EXTERNAL_SCRIPT'
                               , program_action => '/opt/oracle/USIM/SH/run_sql.sh'
                               , number_of_arguments => 3
                               , enabled => FALSE
                               , comments => 'Provide program with parameters to run sql script on server in the correct directory for USIM_TEST'
                               )
  ;
  DBMS_SCHEDULER.DEFINE_PROGRAM_ARGUMENT( program_name => 'USIM_RUN_SQL_TEST'
                                        , argument_position => 1
                                        , argument_name => 'SCRIPT_PATH'
                                        , argument_type => 'VARCHAR2'
                                        , default_value => '/opt/oracle/USIM/SETUP'
                                        )
  ;
  DBMS_SCHEDULER.DEFINE_PROGRAM_ARGUMENT( program_name => 'USIM_RUN_SQL_TEST'
                                        , argument_position => 2
                                        , argument_name => 'SCRIPT_NAME'
                                        , argument_type => 'VARCHAR2'
                                        , default_value => 'USIM_TEST_SETUP.sql'
                                        )
  ;
  DBMS_SCHEDULER.DEFINE_PROGRAM_ARGUMENT( program_name => 'USIM_RUN_SQL_TEST'
                                        , argument_position => 3
                                        , argument_name => 'DB_USER'
                                        , argument_type => 'VARCHAR2'
                                        , default_value => 'USIM_TEST'
                                        )
  ;
  DBMS_SCHEDULER.ENABLE( name => 'USIM_RUN_SQL_TEST');
  DBMS_SCHEDULER.CREATE_JOB( job_name => 'USIM_RUN_SERVER_SQL'
                           , program_name => 'USIM_RUN_SQL'
                           , start_date => NULL
                           , repeat_interval => NULL
                           , end_date => NULL
                           , enabled => FALSE
                           , job_class => 'USIM_JOBS'
                           , auto_drop => FALSE
                           , comments => 'Runs sql scripts on the server for USIM'
                           , credential_name => 'USIM_OS_ACCESS'
                           , job_style => 'REGULAR'
                           );

  DBMS_SCHEDULER.SET_ATTRIBUTE( name => 'USIM_RUN_SERVER_SQL'
                              , attribute => 'store_output'
                              , value => TRUE
                              )
  ;
  DBMS_SCHEDULER.SET_ATTRIBUTE( name => 'USIM_RUN_SERVER_SQL'
                              , attribute => 'logging_level'
                              , value => DBMS_SCHEDULER.LOGGING_FULL
                              )
  ;
  DBMS_SCHEDULER.SET_ATTRIBUTE( name => 'USIM_RUN_SERVER_SQL'
                              , attribute => 'connect_credential_name'
                              , value => 'USIM_DB_ACCESS'
                              )
  ;
  DBMS_SCHEDULER.CREATE_JOB( job_name => 'USIM_RUN_SERVER_SQL_TEST'
                           , program_name => 'USIM_RUN_SQL_TEST'
                           , start_date => NULL
                           , repeat_interval => NULL
                           , end_date => NULL
                           , enabled => FALSE
                           , job_class => 'USIM_JOBS'
                           , auto_drop => FALSE
                           , comments => 'Runs sql scripts on the server for USIM_TEST'
                           , credential_name => 'USIM_OS_ACCESS'
                           , job_style => 'REGULAR'
                           )
  ;
  DBMS_SCHEDULER.SET_ATTRIBUTE( name => 'USIM_RUN_SERVER_SQL_TEST'
                              , attribute => 'store_output'
                              , value => TRUE
                              )
  ;
  DBMS_SCHEDULER.SET_ATTRIBUTE( name => 'USIM_RUN_SERVER_SQL_TEST'
                              , attribute => 'logging_level'
                              , value => DBMS_SCHEDULER.LOGGING_FULL
                              )
  ;
  DBMS_SCHEDULER.SET_ATTRIBUTE( name => 'USIM_RUN_SERVER_SQL_TEST'
                              , attribute => 'connect_credential_name'
                              , value => 'USIM_DB_ACCESS_TEST'
                              )
  ;
  -- no job enable, runs instantly
END;
PL/SQL-Prozedur erfolgreich abgeschlossen.
SQL> -- CREATE PROCEDURES
SQL> SELECT 'CREATE USIM related procedures' AS info FROM dual;

INFO
------------------------------
CREATE USIM related procedures

1 Zeile ausgewählt.

SQL> SELECT CASE
  2           WHEN COUNT(*) = 0
  3           THEN '../PROCEDURES/USIM_RUN_SCRIPT.sql'
  4           ELSE '../UTIL/NOTHING_TO_DO.sql "USIM_RUN_SCRIPT procedure already exists."'
  5         END AS SCRIPTFILE
  6    FROM dba_objects
  7   WHERE object_name LIKE 'USIM_RUN_SCRIPT'
  8     AND object_type = 'PROCEDURE'
  9  ;

SCRIPTFILE
---------------------------------------------------------------------
../PROCEDURES/USIM_RUN_SCRIPT.sql

1 Zeile ausgewählt.

SQL> @@&SCRIPTFILE
SQL> CREATE OR REPLACE PROCEDURE usim_run_script( p_job_name IN VARCHAR2
  2                                             , p_script   IN VARCHAR2 DEFAULT NULL
  3                                             , p_path     IN VARCHAR2 DEFAULT NULL
  4                                             )
  5  /**
  6  * Starts the scheduler job to run a given script or recreate of the schema. If script is not
  7  * given the setup scripts are run that recreate the schema. No checks are done on the given
  8  * script so it may fail on execution. Reserved by SYS. Timeout has to be controlled by provided
  9  * procedures granted to USIM users.
 10  * @param p_job_name Mandatory. The job to run, e.g. RUN_SERVER_SQL or RUN_SERVER_SQL_TEST.
 11  * @param p_script Either NULL or a valid file name including extension that exists on the database server.
 12  * @param p_path Either NULL or a valid path that exists on the database server.
 13  */
 14  IS
 15  BEGIN
 16      IF p_script IS NOT NULL
 17      THEN
 18        -- set parameter
 19        DBMS_SCHEDULER.SET_JOB_ARGUMENT_VALUE( job_name       => p_job_name
 20                                             , argument_name  => 'SCRIPT_NAME'
 21                                             , argument_value => p_script
 22                                             )
 23        ;
 24      END IF;
 25      IF p_path IS NOT NULL
 26      THEN
 27        -- set parameter
 28        DBMS_SCHEDULER.SET_JOB_ARGUMENT_VALUE( job_name       => p_job_name
 29                                             , argument_name  => 'SCRIPT_PATH'
 30                                             , argument_value => p_path
 31                                             )
 32        ;
 33      END IF;
 34      -- run job once
 35      DBMS_SCHEDULER.RUN_JOB(job_name => p_job_name);
 36  END;
 37  /

Procedure USIM_RUN_SCRIPT kompiliert

SQL> SELECT CASE
  2           WHEN COUNT(*) = 0
  3           THEN '../PROCEDURES/USIM_RUN_RECREATE.sql'
  4           ELSE '../UTIL/NOTHING_TO_DO.sql "USIM_RUN_RECREATE procedure already exists."'
  5         END AS SCRIPTFILE
  6    FROM dba_objects
  7   WHERE object_name LIKE 'USIM_RUN_RECREATE'
  8     AND object_type = 'PROCEDURE'
  9  ;

SCRIPTFILE
-----------------------------------------------------------------------
../PROCEDURES/USIM_RUN_RECREATE.sql

1 Zeile ausgewählt.

SQL> @@&SCRIPTFILE
SQL> CREATE OR REPLACE PROCEDURE usim_run_recreate( p_caller   IN VARCHAR2
  2                                               , p_timeout  IN NUMBER DEFAULT NULL
  3                                               )
  4  /**
  5  * Wrapper for USIM_RUN_SCRIPT to run setup for USIM main user. Setup will drop also all existing objects of USIM.
  6  * The finished state is detected by the scheduler log entry. Status can be FAILED or SUCCEEDED. There is an overall
  7  * timeout of 8 hours, scripts called should not take longer.
  8  * @param p_caller The schema to use, APEX should submit '#OWNER#' as parameter.
  9  * @param p_timeout The timeout for waiting to finish job in minutes, if NULL (default) wait until finished.
 10  */
 11  IS
 12    l_job_name        VARCHAR2(128);
 13    l_package         VARCHAR2(128);
 14    l_startdate       TIMESTAMP;
 15    l_enddate         TIMESTAMP;
 16    l_is_done         INTEGER;
 17    l_is_schema_done  INTEGER;
 18    CURSOR cur_done( cp_startdate IN TIMESTAMP
 19                   , cp_job_name  IN VARCHAR2
 20                   )
 21    IS
 22      SELECT COUNT(*) AS is_done
 23        FROM dba_scheduler_job_log
 24       WHERE job_name  = cp_job_name
 25         AND operation = 'RUN'
 26         AND status   IN ('SUCCEEDED', 'FAILED')
 27         AND log_date  > cp_startdate
 28    ;
 29    -- end of install by last object installed, should be USIM_APEX or USIM_TEST package
 30    CURSOR cur_schema_done( cp_owner    IN VARCHAR2
 31                          , cp_package  IN VARCHAR2
 32                          )
 33    IS
 34      SELECT COUNT(*)
 35        FROM dba_objects
 36       WHERE owner        = cp_owner
 37         AND object_name  = cp_package
 38         AND object_type  = 'PACKAGE BODY'
 39    ;
 40  BEGIN
 41    -- check caller
 42    IF p_caller NOT IN ('USIM', 'USIM_TEST')
 43    THEN
 44      -- do not anything if caller is not USIM or USIM_TEST
 45      RETURN;
 46    ELSE
 47      IF p_caller = 'USIM'
 48      THEN
 49        l_job_name := 'USIM_RUN_SERVER_SQL';
 50        l_package  := 'USIM_APEX';
 51      ELSE
 52        l_job_name := 'USIM_RUN_SERVER_SQL_TEST';
 53        l_package  := 'USIM_TEST';
 54      END IF;
 55    END IF;
 56    l_startdate := SYSTIMESTAMP;
 57    usim_run_script(p_job_name  => l_job_name);
 58    -- only positive numbers
 59    IF NVL(p_timeout, 0) > 0
 60    THEN
 61      l_enddate := l_startdate + (INTERVAL '1' MINUTE * p_timeout);
 62    ELSE
 63      -- overall timeout
 64      l_enddate := l_startdate + INTERVAL '8' HOUR;
 65    END IF;
 66    -- loop until done or timeout
 67    LOOP
 68      l_is_done := 0;
 69      l_is_schema_done := 0;
 70      OPEN cur_done(l_startdate, l_job_name);
 71      FETCH cur_done INTO l_is_done;
 72      CLOSE cur_done;
 73      OPEN cur_schema_done(p_caller, l_package);
 74      FETCH cur_schema_done INTO l_is_schema_done;
 75      CLOSE cur_schema_done;
 76      EXIT WHEN (l_is_done > 0 AND l_is_schema_done > 0) OR SYSTIMESTAMP > l_enddate;
 77      DBMS_SESSION.SLEEP(5);
 78    END LOOP;
 79  END;
 80  /

Procedure USIM_RUN_RECREATE kompiliert

SQL> SELECT CASE
  2           WHEN COUNT(*) = 0
  3           THEN '../PROCEDURES/USIM_RUN_TEST.sql'
  4           ELSE '../UTIL/NOTHING_TO_DO.sql "USIM_RUN_TEST procedure already exists."'
  5         END AS SCRIPTFILE
  6    FROM dba_objects
  7   WHERE object_name LIKE 'USIM_RUN_TEST'
  8     AND object_type = 'PROCEDURE'
  9  ;

SCRIPTFILE
-------------------------------------------------------------------
../PROCEDURES/USIM_RUN_TEST.sql

1 Zeile ausgewählt.

SQL> @@&SCRIPTFILE
SQL> CREATE OR REPLACE PROCEDURE usim_run_test
  2  /**
  3  * Wrapper for USIM_RUN_SCRIPT to run test script for USIM_TEST main user.
  4  */
  5  IS
  6    l_path VARCHAR2(4000);
  7  BEGIN
  8    SELECT directory_path || delimiter || 'TESTING' AS test_path
  9      INTO l_path
 10      FROM (SELECT directory_path
 11                 , CASE
 12                     WHEN INSTR(directory_path, ':')
 13                     THEN '\'
 14                     ELSE '/'
 15                   END AS delimiter
 16              FROM dba_directories
 17             WHERE directory_name = 'USIM_SCRIPT_DIR'
 18           )
 19    ;
 20    usim_run_script( p_job_name  => 'USIM_RUN_SERVER_SQL_TEST'
 21                   , p_script    => 'USIM_TESTS.sql'
 22                   , p_path      => l_path
 23                   )
 24    ;
 25  END;
 26  /

Procedure USIM_RUN_TEST kompiliert

SQL> SELECT CASE
  2           WHEN COUNT(*) = 0
  3           THEN '../PROCEDURES/USIM_RUN_TESTDATA.sql'
  4           ELSE '../UTIL/NOTHING_TO_DO.sql "USIM_RUN_TESTDATA procedure already exists."'
  5         END AS SCRIPTFILE
  6    FROM dba_objects
  7   WHERE object_name LIKE 'USIM_RUN_TESTDATA'
  8     AND object_type = 'PROCEDURE'
  9  ;

SCRIPTFILE
-----------------------------------------------------------------------
../PROCEDURES/USIM_RUN_TESTDATA.sql

1 Zeile ausgewählt.

SQL> @@&SCRIPTFILE
SQL> CREATE OR REPLACE PROCEDURE usim_run_testdata
  2  /**
  3  * Wrapper for USIM_RUN_SCRIPT to run test script for USIM_TEST main user.
  4  */
  5  IS
  6    l_path VARCHAR2(4000);
  7  BEGIN
  8    SELECT directory_path || delimiter || 'TESTING' AS test_path
  9      INTO l_path
 10      FROM (SELECT directory_path
 11                 , CASE
 12                     WHEN INSTR(directory_path, ':')
 13                     THEN '\'
 14                     ELSE '/'
 15                   END AS delimiter
 16              FROM dba_directories
 17             WHERE directory_name = 'USIM_SCRIPT_DIR'
 18           )
 19    ;
 20    usim_run_script( p_job_name  => 'USIM_RUN_SERVER_SQL_TEST'
 21                   , p_script    => 'BASIC_TEST_DATA_SETUP.sql'
 22                   , p_path      => l_path
 23                   )
 24    ;
 25  END;
 26  /

Procedure USIM_RUN_TESTDATA kompiliert

SQL> -- CREATE FUNCTIONS
SQL> SELECT 'CREATE USIM related functions' AS info FROM dual;

INFO
-----------------------------
CREATE USIM related functions

1 Zeile ausgewählt.

SQL> SELECT CASE
  2           WHEN COUNT(*) = 0
  3           THEN '../FUNCTIONS/USIM_FILETYPE.sql'
  4           ELSE '../UTIL/NOTHING_TO_DO.sql "USIM_FILETYPE function already exists."'
  5         END AS SCRIPTFILE
  6    FROM dba_objects
  7   WHERE object_name LIKE 'USIM_FILETYPE'
  8     AND object_type = 'FUNCTION'
  9  ;

SCRIPTFILE
------------------------------------------------------------------
../FUNCTIONS/USIM_FILETYPE.sql

1 Zeile ausgewählt.

SQL> @@&SCRIPTFILE
SQL> CREATE OR REPLACE FUNCTION usim_filetype( p_filename  IN VARCHAR2
  2                                          , p_directory IN VARCHAR2 DEFAULT 'USIM_LOG_DIR'
  3                                          )
  4    RETURN VARCHAR2
  5  IS
  6    l_file        UTL_FILE.FILE_TYPE;
  7    -- minimum raw buffer is 512
  8    l_buffer      RAW(512);
  9    l_bufsize     CONSTANT PLS_INTEGER := 512;
 10    l_lf          RAW(1);
 11    l_cr          RAW(1);
 12    l_line        INTEGER;
 13    l_type        VARCHAR2(2000);
 14  BEGIN
 15    l_type := 'ERROR';
 16    l_line := -3;
 17    l_lf   := utl_raw.cast_to_raw(CHR(10));
 18    l_line := -2;
 19    l_cr   := utl_raw.cast_to_raw(CHR(13));
 20    l_line := -1;
 21    l_file := UTL_FILE.FOPEN(p_directory, p_filename, 'r', l_bufsize);
 22    l_line := 0;
 23    LOOP
 24      -- loop as long as needed to find first line end
 25      BEGIN
 26        l_line := l_line +1;
 27        UTL_FILE.GET_RAW(l_file, l_buffer, l_bufsize);
 28        -- loop char by char through buffer
 29        FOR l_idx IN 1..l_bufsize
 30        LOOP
 31          IF utl_raw.SUBSTR(l_buffer, l_idx, 1) = l_cr
 32          THEN
 33              -- first found CR, checkout if Windows or Mac
 34              IF utl_raw.SUBSTR(l_buffer, l_idx + 1, 1) = l_lf
 35              THEN
 36                l_type := 'CRLF';
 37              ELSE
 38                l_type := 'CR';
 39              END IF;
 40              EXIT;
 41          END IF;
 42          IF utl_raw.SUBSTR(l_buffer, l_idx, 1) = l_lf
 43          THEN
 44              -- first found LF, so UNIX style
 45              l_type := 'LF';
 46              EXIT;
 47          END IF;
 48        END LOOP;
 49      EXCEPTION
 50        WHEN NO_DATA_FOUND THEN
 51          -- read until end if needed: no data found and no line end delimiter found
 52          l_type := 'ERROR no CR or LF found in ' || p_filename|| ' directory: ' || p_directory;
 53          EXIT;
 54      END;
 55      EXIT WHEN l_type != 'ERROR';
 56    END LOOP;
 57    UTL_FILE.FCLOSE(l_file);
 58    RETURN l_type;
 59  EXCEPTION
 60    WHEN OTHERS THEN
 61      RETURN 'Error USIM_FILETYPE filename: ' || p_filename || ' directory: ' || p_directory || ' line: ' || l_line || ' ' || SQLERRM;
 62  END;
 63  /

Function USIM_FILETYPE kompiliert

SQL> SELECT CASE
  2           WHEN COUNT(*) = 0
  3           THEN '../FUNCTIONS/USIM_LOAD_LOG.sql'
  4           ELSE '../UTIL/NOTHING_TO_DO.sql "USIM_LOAD_LOG function already exists."'
  5         END AS SCRIPTFILE
  6    FROM dba_objects
  7   WHERE object_name LIKE 'USIM_LOAD_LOG'
  8     AND object_type = 'FUNCTION'
  9  ;

SCRIPTFILE
------------------------------------------------------------------
../FUNCTIONS/USIM_LOAD_LOG.sql

1 Zeile ausgewählt.

SQL> @@&SCRIPTFILE
SQL> CREATE OR REPLACE FUNCTION usim_load_log( p_filename  IN VARCHAR2
  2                                          , p_platform  IN VARCHAR2 DEFAULT 'Win32'
  3                                          , p_directory IN VARCHAR2 DEFAULT 'USIM_LOG_DIR'
  4                                          )
  5    RETURN CLOB
  6  IS
  7    /** Function for USIM to read logs from disc.
  8    * Expect SQL logs with max. linesize 9999 set. Needs to consider that DBA files are probably created on
  9    * windows and APEX runs as well mostly under windows. May only work with Windows Client and OVA server.
 10    * If log file is unix type and client is windows the new line is corrected to CRLF.
 11    * @param p_filename The name of the log file that resides in the given directory, e.g. USIM_SETUP.log.
 12    * @param p_platform The client platform used. Default is Win32. Useful if enviroments server/client differ to display logs correctly.
 13    * @param p_directory The name of a valid directory for logs. Default is USIM_LOG_DIR.
 14    * @return A CLOB containing either the file content or the error message why file could not be loaded.
 15    */
 16    l_clob        CLOB;
 17    l_file        UTL_FILE.FILE_TYPE;
 18    l_buffer      VARCHAR2(10024);
 19    l_bufsize     CONSTANT PLS_INTEGER := 10024;
 20    l_cr          VARCHAR2(1) := CHR(13);
 21    l_lf          VARCHAR2(1) := CHR(10);
 22    l_buffer_crlf VARCHAR(32000);
 23    l_line        INTEGER;
 24    l_filetype    VARCHAR2(2000);
 25    l_system      VARCHAR2(128);
 26  BEGIN
 27    IF INSTR(UPPER(p_platform), 'WIN') > 0
 28    THEN
 29      l_system := 'WINDOWS';
 30    ELSE
 31      l_system := 'UNIX';
 32    END IF;
 33    l_line := -3;
 34    l_filetype := usim_filetype(p_filename, p_directory);
 35    IF INSTR(UPPER(l_filetype), 'ERROR') > 0
 36    THEN
 37      RETURN 'ERROR USIM_LOAD_LOG checking file type: ' || l_filetype;
 38    END IF;
 39    l_line := -2;
 40    l_file := UTL_FILE.FOPEN(p_directory, p_filename, 'r', l_bufsize);
 41    l_line := -1;
 42    DBMS_LOB.CREATETEMPORARY(l_clob, TRUE, DBMS_LOB.CALL);
 43    l_line := 0;
 44    LOOP
 45      BEGIN
 46        l_line := l_line +1;
 47        UTL_FILE.GET_LINE(l_file, l_buffer);
 48        -- empty buffers through different lf/crlf settings cause errors if running APEX on windows.
 49        IF l_buffer IS NULL
 50        THEN
 51          IF l_filetype != 'CRLF' AND l_system = 'WINDOWS'
 52          THEN
 53            l_buffer_crlf := l_cr;
 54          ELSE
 55            l_buffer_crlf := l_lf;
 56          END IF;
 57        ELSE
 58          IF l_filetype != 'CRLF' AND l_system = 'WINDOWS'
 59          THEN
 60            l_buffer_crlf := RTRIM(l_buffer) || l_cr;
 61          ELSE
 62            l_buffer_crlf := RTRIM(l_buffer);
 63          END IF;
 64        END IF;
 65        DBMS_LOB.WRITEAPPEND(l_clob, LENGTH(l_buffer_crlf), l_buffer_crlf);
 66      EXCEPTION
 67        WHEN NO_DATA_FOUND THEN
 68          -- read until end: no data found
 69          EXIT;
 70      END;
 71    END LOOP;
 72    UTL_FILE.FCLOSE(l_file);
 73    RETURN l_clob;
 74  EXCEPTION
 75    WHEN OTHERS THEN
 76      l_clob := 'Error USIM_LOAD_LOG filename: ' || p_filename || ' directory: ' || p_directory || ' line: ' || l_line || ' ' || SQLERRM;
 77      RETURN l_clob;
 78  END;
 79  /

Function USIM_LOAD_LOG kompiliert

SQL> -- CREATE VIEWS
SQL> SELECT 'CREATE USIM related views' AS info FROM dual;

INFO
-------------------------
CREATE USIM related views

1 Zeile ausgewählt.

SQL> SELECT CASE
  2           WHEN COUNT(*) = 0
  3           THEN '../VIEW/USIM_INSTALL_STATE.sql'
  4           ELSE '../UTIL/NOTHING_TO_DO.sql "View USIM_INSTALL_STATE already exists."'
  5         END AS SCRIPTFILE
  6    FROM dba_objects
  7   WHERE object_name = 'USIM_INSTALL_STATE'
  8     AND object_type = 'VIEW'
  9  ;

SCRIPTFILE
-------------------------------------------------------------------
../VIEW/USIM_INSTALL_STATE.sql

1 Zeile ausgewählt.

SQL> @@&SCRIPTFILE
SQL> -- SYS view granted to manage install state situations, needed by DBA setup
SQL> CREATE OR REPLACE VIEW usim_install_state AS
  2      WITH lst AS
  3           (SELECT CASE
  4                     WHEN SYS_CONTEXT('USERENV', 'CURRENT_SCHEMA') = 'USIM'
  5                     -- adjust list if new packages are released
  6                     THEN 'USIM_ERL,USIM_DEBUG,USIM_STATIC,USIM_MATHS,USIM_BASE,USIM_MLV,USIM_POS,USIM_DIM,USIM_SPR,USIM_DBIF,USIM_CREATOR,USIM_PROCESS,USIM_NOD,USIM_RMD,USIM_SPC,USIM_CHI,USIM_SPO,USIM_APEX'
  7                     ELSE 'USIM_ERL,USIM_DEBUG,USIM_STATIC,USIM_MATHS,USIM_BASE,USIM_MLV,USIM_POS,USIM_DIM,USIM_SPR,USIM_DBIF,USIM_CREATOR,USIM_PROCESS,USIM_NOD,USIM_RMD,USIM_SPC,USIM_CHI,USIM_SPO,USIM_APEX,USIM_TEST'
  8                   END AS object_list
  9                   -- adjust expected count if new packages are released
 10                 , CASE
 11                     WHEN SYS_CONTEXT('USERENV', 'CURRENT_SCHEMA') = 'USIM' THEN 36
 12                     WHEN SYS_CONTEXT('USERENV', 'CURRENT_SCHEMA') = 'USIM_TEST' THEN 38
 13                     ELSE -1
 14                   END AS cnt_expected
 15                 , CASE
 16                     WHEN SYS_CONTEXT('USERENV', 'CURRENT_SCHEMA') = 'USIM' THEN 0
 17                     WHEN SYS_CONTEXT('USERENV', 'CURRENT_SCHEMA') = 'USIM_TEST' THEN 1
 18                     ELSE -1
 19                   END AS is_test_env
 20              FROM dual
 21           )
 22         , obj AS
 23           (SELECT COUNT(*) AS cnt_objects
 24              FROM all_objects
 25              LEFT OUTER JOIN lst ON 1 = 1
 26             WHERE owner = SYS_CONTEXT('USERENV', 'CURRENT_SCHEMA')
 27               AND INSTR(lst.object_list, all_objects.object_name) > 0
 28           )
 29         , val AS
 30           (SELECT COUNT(CASE WHEN status = 'VALID' THEN 1 END) AS cnt_valid
 31                 , COUNT(CASE WHEN status != 'VALID' THEN 1 END) AS cnt_invalid
 32              FROM all_objects
 33                   -- exclude synonyms from SYS
 34             WHERE owner = SYS_CONTEXT('USERENV', 'CURRENT_SCHEMA')
 35               AND object_type != 'SYNONYM'
 36           )
 37    SELECT CASE
 38             WHEN SYS_CONTEXT('USERENV', 'CURRENT_SCHEMA') IN ('USIM', 'USIM_TEST')
 39             THEN CASE
 40                    WHEN SYS_CONTEXT('USERENV', 'CURRENT_SCHEMA') = 'USIM'
 41                    THEN CASE
 42                           WHEN obj.cnt_objects = lst.cnt_expected
 43                            AND val.cnt_invalid = 0
 44                            AND val.cnt_valid  != 0
 45                           THEN 1
 46                           WHEN obj.cnt_objects  = lst.cnt_expected
 47                            AND val.cnt_invalid != 0
 48                            AND val.cnt_valid   != 0
 49                           THEN -10
 50                           WHEN obj.cnt_objects != lst.cnt_expected
 51                            AND val.cnt_invalid != 0
 52                            AND val.cnt_valid   != 0
 53                           THEN -11
 54                           WHEN obj.cnt_objects != lst.cnt_expected
 55                            AND val.cnt_invalid  = 0
 56                            AND val.cnt_valid   != 0
 57                           THEN -12
 58                           ELSE 0
 59                         END
 60                    ELSE CASE
 61                           WHEN obj.cnt_objects = lst.cnt_expected
 62                            AND val.cnt_invalid = 0
 63                            AND val.cnt_valid  != 0
 64                           THEN 2
 65                           WHEN obj.cnt_objects = lst.cnt_expected
 66                            AND val.cnt_invalid != 0
 67                            AND val.cnt_valid   != 0
 68                           THEN -20
 69                           WHEN obj.cnt_objects != lst.cnt_expected
 70                            AND val.cnt_invalid != 0
 71                            AND val.cnt_valid   != 0
 72                           THEN -21
 73                           WHEN obj.cnt_objects != lst.cnt_expected
 74                            AND val.cnt_invalid  = 0
 75                            AND val.cnt_valid   != 0
 76                           THEN -22
 77                           ELSE 0
 78                         END
 79                  END
 80             ELSE -99
 81           END AS status
 82         , CASE
 83             WHEN SYS_CONTEXT('USERENV', 'CURRENT_SCHEMA') IN ('USIM', 'USIM_TEST')
 84             THEN CASE
 85                    WHEN SYS_CONTEXT('USERENV', 'CURRENT_SCHEMA') = 'USIM'
 86                    THEN CASE
 87                           WHEN obj.cnt_objects = lst.cnt_expected
 88                            AND val.cnt_invalid = 0
 89                            AND val.cnt_valid  != 0
 90                           THEN 'USim system installed and valid'
 91                           WHEN obj.cnt_objects  = lst.cnt_expected
 92                            AND val.cnt_invalid != 0
 93                            AND val.cnt_valid   != 0
 94                           THEN 'Invalid objects found in USim system, objects complete'
 95                           WHEN obj.cnt_objects != lst.cnt_expected
 96                            AND val.cnt_invalid != 0
 97                            AND val.cnt_valid   != 0
 98                           THEN 'Invalid and missing objects found in USim system'
 99                           WHEN obj.cnt_objects != lst.cnt_expected
100                            AND val.cnt_invalid  = 0
101                            AND val.cnt_valid   != 0
102                           THEN 'Missing objects found in USim system, all objects valid'
103                           ELSE 'No USim system installed yet'
104                         END
105                    ELSE CASE
106                           WHEN obj.cnt_objects = lst.cnt_expected
107                            AND val.cnt_invalid = 0
108                            AND val.cnt_valid  != 0
109                           THEN 'USim test system installed and valid'
110                           WHEN obj.cnt_objects = lst.cnt_expected
111                            AND val.cnt_invalid != 0
112                            AND val.cnt_valid   != 0
113                           THEN 'Invalid objects found in USim test system, objects complete'
114                           WHEN obj.cnt_objects != lst.cnt_expected
115                            AND val.cnt_invalid != 0
116                            AND val.cnt_valid   != 0
117                           THEN 'Invalid and missing objects found in USim test system'
118                           WHEN obj.cnt_objects != lst.cnt_expected
119                            AND val.cnt_invalid  = 0
120                            AND val.cnt_valid   != 0
121                           THEN 'Missing objects found in USim test system, all objects valid'
122                           ELSE 'No USIM test system installed yet'
123                         END
124                  END
125             ELSE 'Not a USim system'
126           END AS status_txt
127         , lst.is_test_env
128         , CASE WHEN lst.is_test_env = 1 THEN 'USim Test Environment' ELSE 'USim Live Environment' END AS is_test_env_txt
129         , lst.cnt_expected
130         , obj.cnt_objects
131         , val.cnt_invalid
132         , val.cnt_valid
133         , USER AS view_user
134         , SYS_CONTEXT('USERENV', 'CURRENT_SCHEMA') AS current_schema
135         , SYS_CONTEXT('USERENV', 'CURRENT_USER') AS current_user
136         , SYS_CONTEXT('USERENV', 'OS_USER') AS os_user
137      FROM obj
138      LEFT OUTER JOIN val ON 1 = 1
139      LEFT OUTER JOIN lst ON 1 = 1
140  ;

View USIM_INSTALL_STATE erstellt.

SQL> -- CREATE PUBLIC SYNONYMS
SQL> SELECT 'CREATE USIM related public synonyms' AS info FROM dual;

INFO
-----------------------------------
CREATE USIM related public synonyms

1 Zeile ausgewählt.

SQL> SELECT CASE
  2           WHEN COUNT(*) = 0
  3           THEN 'USIM_PUBLIC_SYNONYMS.sql'
  4           WHEN COUNT(*) = 6
  5           THEN '../UTIL/NOTHING_TO_DO.sql "Public synonyms already exists."'
  6           ELSE '../UTIL/EXIT_SCRIPT_WITH_ERROR.sql "Cleanup failed remove public synonyms manually before."'
  7         END AS SCRIPTFILE
  8    FROM dba_objects
  9   WHERE owner        = 'PUBLIC'
 10     AND object_type  = 'SYNONYM'
 11     AND object_name IN ('USIM_INSTALL_STATE', 'USIM_RUN_SCRIPT', 'USIM_RUN_RECREATE', 'USIM_RUN_TEST', 'USIM_RUN_TESTDATA', 'USIM_LOAD_LOG')
 12  ;

SCRIPTFILE
-------------------------------------------------------------------------------------------
USIM_PUBLIC_SYNONYMS.sql

1 Zeile ausgewählt.

SQL> @@&SCRIPTFILE
SQL> CREATE PUBLIC SYNONYM usim_install_state FOR usim_install_state;

SYNONYM USIM_INSTALL_STATE erstellt.

SQL> CREATE PUBLIC SYNONYM usim_run_script FOR usim_run_script;

SYNONYM USIM_RUN_SCRIPT erstellt.

SQL> CREATE PUBLIC SYNONYM usim_run_recreate FOR usim_run_recreate;

SYNONYM USIM_RUN_RECREATE erstellt.

SQL> CREATE PUBLIC SYNONYM usim_run_test FOR usim_run_test;

SYNONYM USIM_RUN_TEST erstellt.

SQL> CREATE PUBLIC SYNONYM usim_run_testdata FOR usim_run_testdata;

SYNONYM USIM_RUN_TESTDATA erstellt.

SQL> CREATE PUBLIC SYNONYM usim_load_log FOR usim_load_log;

SYNONYM USIM_LOAD_LOG erstellt.

SQL> -- CREATE USERS
SQL> SELECT 'CREATE USIM users' AS info FROM dual;

INFO
-----------------
CREATE USIM users

1 Zeile ausgewählt.

SQL> -- USIM
SQL> SELECT CASE
  2           WHEN COUNT(*) = 0
  3           THEN 'USIM_CREATE_USER.sql'
  4           ELSE '../UTIL/NOTHING_TO_DO.sql "User USIM already exists."'
  5         END AS SCRIPTFILE
  6    FROM dba_users
  7   WHERE username = 'USIM'
  8  ;

SCRIPTFILE
-----------------------------------------------------
USIM_CREATE_USER.sql

1 Zeile ausgewählt.

SQL> @@&SCRIPTFILE
SQL> CREATE USER usim IDENTIFIED BY &PASS_USIM;
alt:CREATE USER usim IDENTIFIED BY &PASS_USIM
neu:CREATE USER usim IDENTIFIED BY usim

User USIM erstellt.

SQL> ALTER USER usim
  2  DEFAULT TABLESPACE usim_live
  3  ACCOUNT UNLOCK;

User USIM geändert.

SQL> -- QUOTAS
SQL> ALTER USER usim QUOTA UNLIMITED ON usim_live;

User USIM geändert.

SQL> -- ROLES
SQL> -- basic roles
SQL> GRANT GATHER_SYSTEM_STATISTICS, CONNECT, RESOURCE TO usim;

Grant erfolgreich.

SQL> -- privileges
SQL> GRANT CREATE VIEW TO usim;

Grant erfolgreich.

SQL> GRANT ALL ON DIRECTORY usim_dir TO usim;

Grant erfolgreich.

SQL> GRANT ALL ON DIRECTORY usim_hist_dir TO usim;

Grant erfolgreich.

SQL> GRANT EXECUTE ON UTL_FILE to usim;

Grant erfolgreich.

SQL> GRANT EXECUTE ON DBMS_LOB to usim;

Grant erfolgreich.

SQL> GRANT MANAGE SCHEDULER TO usim;

Grant erfolgreich.

SQL> GRANT CREATE EXTERNAL JOB TO usim;

Grant erfolgreich.

SQL> GRANT EXECUTE ANY PROGRAM TO usim;

Grant erfolgreich.

SQL> GRANT ALL ON DIRECTORY usim_dir TO usim;

Grant erfolgreich.

SQL> GRANT ALL ON DIRECTORY usim_hist_dir TO usim;

Grant erfolgreich.

SQL> GRANT ALL ON DIRECTORY usim_script_dir TO usim;

Grant erfolgreich.

SQL> GRANT ALL ON usim_os_access TO usim;

Grant erfolgreich.

SQL> GRANT ALL ON usim_db_access TO usim;

Grant erfolgreich.

SQL> GRANT ALL ON usim_run_sql TO usim;

Grant erfolgreich.

SQL> GRANT ALL ON usim_run_server_sql TO usim;

Grant erfolgreich.

SQL> GRANT ALL ON usim_run_recreate TO usim;

Grant erfolgreich.

SQL> GRANT ALL ON usim_run_script TO usim;

Grant erfolgreich.

SQL> GRANT ALL ON usim_install_state TO usim;

Grant erfolgreich.

SQL> GRANT ALL ON usim_load_log TO usim;

Grant erfolgreich.

SQL> -- USIM_TEST
SQL> SELECT CASE
  2           WHEN COUNT(*) = 0
  3           THEN 'USIM_CREATE_TESTUSER.sql'
  4           ELSE '../UTIL/NOTHING_TO_DO.sql "User USIM_TEST already exists."'
  5         END AS SCRIPTFILE
  6    FROM dba_users
  7   WHERE username = 'USIM_TEST'
  8  ;

SCRIPTFILE
----------------------------------------------------------
USIM_CREATE_TESTUSER.sql

1 Zeile ausgewählt.

SQL> @@&SCRIPTFILE
SQL> CREATE USER usim_test IDENTIFIED BY &PASS_USIM_TEST;
alt:CREATE USER usim_test IDENTIFIED BY &PASS_USIM_TEST
neu:CREATE USER usim_test IDENTIFIED BY usim

User USIM_TEST erstellt.

SQL>
SQL> ALTER USER usim_test
  2  DEFAULT TABLESPACE usim_test
  3  ACCOUNT UNLOCK;

User USIM_TEST geändert.

SQL>
SQL> -- QUOTAS
SQL> ALTER USER usim_test QUOTA UNLIMITED ON usim_test;

User USIM_TEST geändert.

SQL>
SQL> -- ROLES
SQL> -- basic roles
SQL> GRANT GATHER_SYSTEM_STATISTICS, CONNECT, RESOURCE TO usim_test;

Grant erfolgreich.

SQL>
SQL> -- privileges
SQL> GRANT CREATE VIEW TO usim_test;

Grant erfolgreich.

SQL> GRANT ALL ON DIRECTORY usim_dir TO usim_test;

Grant erfolgreich.

SQL> GRANT ALL ON DIRECTORY usim_hist_dir TO usim_test;

Grant erfolgreich.

SQL> GRANT ALL ON DIRECTORY usim_script_dir TO usim_test;

Grant erfolgreich.

SQL> GRANT EXECUTE ON UTL_FILE to usim_test;

Grant erfolgreich.

SQL> GRANT EXECUTE ON DBMS_LOB to usim_test;

Grant erfolgreich.

SQL> GRANT MANAGE SCHEDULER TO usim_test;

Grant erfolgreich.

SQL> GRANT CREATE EXTERNAL JOB TO usim_test;

Grant erfolgreich.

SQL> GRANT EXECUTE ANY PROGRAM TO usim_test;

Grant erfolgreich.

SQL> GRANT ALL ON usim_os_access TO usim_test;

Grant erfolgreich.

SQL> GRANT ALL ON usim_db_access_test TO usim_test;

Grant erfolgreich.

SQL> GRANT ALL ON usim_run_sql_test TO usim_test;

Grant erfolgreich.

SQL> GRANT ALL ON usim_run_server_sql_test TO usim_test;

Grant erfolgreich.

SQL> GRANT ALL ON usim_run_recreate TO usim_test;

Grant erfolgreich.

SQL> GRANT ALL ON usim_run_script TO usim_test;

Grant erfolgreich.

SQL> GRANT ALL ON usim_run_test TO usim_test;

Grant erfolgreich.

SQL> GRANT ALL ON usim_run_testdata TO usim_test;

Grant erfolgreich.

SQL> GRANT ALL ON usim_install_state TO usim_test;

Grant erfolgreich.

SQL> GRANT ALL ON usim_load_log TO usim_test;

Grant erfolgreich.

SQL> SELECT owner, object_name, object_type, status FROM dba_objects WHERE status != 'VALID';

0 Zeilen ausgewählt.

SQL> SPOOL OFF
